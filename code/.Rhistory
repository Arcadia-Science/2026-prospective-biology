h_tissue_species_all = mean(tissue_species_one_cond_entropy))
}
h
mean(unlist(lapply(cond_entropy, function(x) x$h_species)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue_species)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue_species_all)))
cond_entropy = list()
for(h in 1:200){
species_cond_entropy = c()
for(i in 1:length(unique(meta$species))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$species)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
species_cond_entropy = c(species_cond_entropy, infotheo::condentropy(h1, h2))
}
tissue_cond_entropy = c()
for(i in 1:length(unique(meta$tissue))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$tissue)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_cond_entropy = c(tissue_cond_entropy, infotheo::condentropy(h1, h2))
}
tissue_species_cond_entropy = c()
for(i in 1:length(unique(meta$tissue_species))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$tissue_species)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_species_cond_entropy = c(tissue_species_cond_entropy,
infotheo::condentropy(h1, h2))
}
x = split(meta$tissue_species, meta$species)
tissue_species_one_cond_entropy = c()
for(i in 1:100){
h1 = hist(as.numeric(expr[h,]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
y = unlist(lapply(x, function(z) z[sample(1:length(z), 1)]))
h2 = hist(as.numeric(expr[h,meta$tissue_species%in%y]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_species_one_cond_entropy = c(tissue_species_one_cond_entropy,
infotheo::condentropy(h1, h2))
}
cond_entropy[[h]] = list(h_species = mean(species_cond_entropy),
h_tissue = mean(tissue_cond_entropy),
h_tissue_species = mean(tissue_species_cond_entropy),
h_tissue_species_all = mean(tissue_species_one_cond_entropy))
}
cond_entropy = list()
for(h in 1:200){
print(h)
species_cond_entropy = c()
for(i in 1:length(unique(meta$species))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$species)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
species_cond_entropy = c(species_cond_entropy, infotheo::condentropy(h1, h2))
}
tissue_cond_entropy = c()
for(i in 1:length(unique(meta$tissue))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$tissue)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_cond_entropy = c(tissue_cond_entropy, infotheo::condentropy(h1, h2))
}
tissue_species_cond_entropy = c()
for(i in 1:length(unique(meta$tissue_species))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$tissue_species)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_species_cond_entropy = c(tissue_species_cond_entropy,
infotheo::condentropy(h1, h2))
}
x = split(meta$tissue_species, meta$species)
tissue_species_one_cond_entropy = c()
for(i in 1:100){
h1 = hist(as.numeric(expr[h,]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
y = unlist(lapply(x, function(z) z[sample(1:length(z), 1)]))
h2 = hist(as.numeric(expr[h,meta$tissue_species%in%y]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_species_one_cond_entropy = c(tissue_species_one_cond_entropy,
infotheo::condentropy(h1, h2))
}
cond_entropy[[h]] = list(h_species = mean(species_cond_entropy),
h_tissue = mean(tissue_cond_entropy),
h_tissue_species = mean(tissue_species_cond_entropy),
h_tissue_species_all = mean(tissue_species_one_cond_entropy))
}
mean(unlist(lapply(cond_entropy, function(x) x$h_species)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue_species)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue_species_all)))
cond_entropy = list()
for(h in 1:nrow(expr)){
print(h)
species_cond_entropy = c()
for(i in 1:length(unique(meta$species))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$species)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
species_cond_entropy = c(species_cond_entropy, infotheo::condentropy(h1, h2))
}
tissue_cond_entropy = c()
for(i in 1:length(unique(meta$tissue))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$tissue)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_cond_entropy = c(tissue_cond_entropy, infotheo::condentropy(h1, h2))
}
tissue_species_cond_entropy = c()
for(i in 1:length(unique(meta$tissue_species))){
h1 = hist(as.numeric(expr[h,]), breaks = seq(0, 13, 0.1), plot = FALSE)$density
h2 = hist(as.numeric(expr[h,grep(unique(meta$tissue_species)[i], colnames(expr))]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_species_cond_entropy = c(tissue_species_cond_entropy,
infotheo::condentropy(h1, h2))
}
x = split(meta$tissue_species, meta$species)
tissue_species_one_cond_entropy = c()
for(i in 1:100){
h1 = hist(as.numeric(expr[h,]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
y = unlist(lapply(x, function(z) z[sample(1:length(z), 1)]))
h2 = hist(as.numeric(expr[h,meta$tissue_species%in%y]),
breaks = seq(0, 13, 0.1), plot = FALSE)$density
h1 = infotheo::discretize(h1)
h2 = infotheo::discretize(h2)
tissue_species_one_cond_entropy = c(tissue_species_one_cond_entropy,
infotheo::condentropy(h1, h2))
}
cond_entropy[[h]] = list(h_species = mean(species_cond_entropy),
h_tissue = mean(tissue_cond_entropy),
h_tissue_species = mean(tissue_species_cond_entropy),
h_tissue_species_all = mean(tissue_species_one_cond_entropy))
}
mean(unlist(lapply(cond_entropy, function(x) x$h_species)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue_species)))
mean(unlist(lapply(cond_entropy, function(x) x$h_tissue_species_all)))
demo_newick <- "((A:0.2,B:0.2):0.2,((C:0.1,D:0.1):0.2,(E:0.15,(F:0.05,G:0.05):0.1):0.15):0.1,H:0.4):0.2;"
# =========================
# 1) Build Brownian-motion covariance from a Newick tree
# =========================
bm_covariance_from_newick <- function(newick_str,
sigma2 = 1.0,
random_order = TRUE,
seed = 1) {
set.seed(seed)
tree <- read.tree(text = newick_str)
S <- length(tree$tip.label)
# vcv.phylo returns the BM variance-covariance matrix
cov_mat <- sigma2 * vcv.phylo(tree)
# Randomize tip order if desired
if (random_order) {
ord <- sample(1:S)
cov_mat <- cov_mat[ord, ord]
} else {
ord <- 1:S
}
list(cov = cov_mat, order = ord, tree = tree)
}
cov = bm_covariance_from_newick(demo_newick)
library(ape)
cov = bm_covariance_from_newick(demo_newick)
cov
simulate_counts_with_cov <- function(Sigma_species,
G = 1500,          # genes
Ctypes = 12,       # cell types per species
R_invariant = 6,   # # invariant latent comps
R_species = 4,     # # species-specific comps
phi = 0.6,         # NB overdispersion
log_mean_scale = 0.6,
celltype_balance = "balanced",
per_celltype_cells = 1000,
label_noise_p = 0.0,
missing_celltypes_frac = 0.0,
seed = 123) {
set.seed(seed)
S <- nrow(Sigma_species) # number of species
R <- R_invariant + R_species
# Gene and cell-type latent factors
A <- matrix(rnorm(G * R), nrow = G)
B <- matrix(rnorm(Ctypes * R), nrow = Ctypes)
# Species factors with BM covariance
L <- chol(Sigma_species)
U <- t(L %*% matrix(rnorm(S * R_invariant), nrow = S))
V <- t(L %*% matrix(rnorm(S * R_species), nrow = S))
# Mean expression (log scale)
log_mu <- array(0, dim = c(G, Ctypes, S))
for (s in 1:S) {
inv_part  <- A[, 1:R_invariant] %*%
t(B[, 1:R_invariant] + matrix(U[, s], nrow = Ctypes, ncol = R_invariant, byrow = TRUE))
spec_part <- (A[, (R_invariant+1):R] %*% diag(V[, s])) %*%
t(B[, (R_invariant+1):R])
log_mu[, , s] <- log_mean_scale * (inv_part + spec_part)
}
mu <- log1p(exp(log_mu)) # softplus
# Sampling weights for balanced vs imbalanced cell types
if (celltype_balance == "imbalanced") {
ranks <- 1:Ctypes
weights <- 1 / ranks
weights <- weights / sum(weights)
W <- t(replicate(S, sample(weights)))
} else {
W <- matrix(1/Ctypes, nrow = S, ncol = Ctypes)
}
# Mask for missing cell types in some species
missing_mask <- matrix(FALSE, nrow = S, ncol = Ctypes)
if (missing_celltypes_frac > 0) {
k <- floor(Ctypes * missing_celltypes_frac)
for (s in 1:S) {
if (k > 0) {
miss <- sample(1:Ctypes, size = k, replace = FALSE)
missing_mask[s, miss] <- TRUE
}
}
}
# NB sampling
size <- 1 / max(phi, 1e-6)
counts <- array(0, dim = c(G, Ctypes, S))
for (s in 1:S) {
for (c in 1:Ctypes) {
if (missing_mask[s, c]) next
depth_scale <- W[s, c] * per_celltype_cells / mean(per_celltype_cells)
lam <- mu[, c, s] * depth_scale
rate <- rgamma(length(lam), shape = size, scale = lam / size)
counts[, c, s] <- rpois(length(rate), lambda = rate)
}
}
# Optional label noise: swap cell type labels within species
if (label_noise_p > 0) {
for (s in 1:S) {
for (c in 1:Ctypes) {
if (runif(1) < label_noise_p) {
c2 <- sample(1:Ctypes, 1)
tmp <- counts[, c, s]
counts[, c, s] <- counts[, c2, s]
counts[, c2, s] <- tmp
}
}
}
}
counts
}
simulate_counts_with_cov(cov$cov)
counts = simulate_counts_with_cov(cov$cov)
counts
counts[,,1]
counts[,,2]
counts[,,3]
counts[,,4]
cor(counts[,,1], counts[,,2])
heatmap(counts[,,1])
heatmap(counts[,,2])
image(counts[,,2])
library(dplyr)
library(scales)
#Load data
#data = read.csv('~/Documents/Conferences:trips/evolution_2025/talk/data/epochai_biology_ai_models.csv')
data = read.csv('~/Desktop/biology_ai_models.csv')
# Convert 'Publication date' to Date type
data <- data %>%
mutate(`Publication.date` = as.Date(`Publication.date`)) %>%
filter(!is.na(`Publication.date`) & !is.na(`Training.compute..FLOP.`))
#Plot
plot(data$Publication.date,
log10(data$Training.compute..FLOP.),
ylim = c(16, 25),
pch = 20,
col = alpha('#3B9886', 0.5),
cex = 2,
ylab = 'Training compute (FLOPs)',
xlab = 'Release date',
cex.axis = 1.5,
cex.lab = 1.5,
bty = 'n',
las = 2)
data = read.csv('~/Desktop/biology_ai_models.csv')
# Convert 'Publication date' to Date type
data <- data %>%
mutate(`Publication.date` = zoo::as.Date(`Publication.date`)) %>%
filter(!is.na(`Publication.date`) & !is.na(`Training.compute..FLOP.`))
#Plot
plot(data$Publication.date,
log10(data$Training.compute..FLOP.),
ylim = c(16, 25),
pch = 20,
col = alpha('#3B9886', 0.5),
cex = 2,
ylab = 'Training compute (FLOPs)',
xlab = 'Release date',
cex.axis = 1.5,
cex.lab = 1.5,
bty = 'n',
las = 2)
data$Publication.date
data = read.csv('~/Documents/Conferences:trips/evolution_2025/talk/data/epochai_biology_ai_models.csv')
data = read.csv('~/Documents/Conferences:trips/evolution_2025/talk/data/epochai_biology_ai_models.csv')
#data = read.csv('~/Desktop/biology_ai_models.csv')
# Convert 'Publication date' to Date type
data <- data %>%
mutate(`Publication.date` = zoo::as.Date(`Publication.date`)) %>%
filter(!is.na(`Publication.date`) & !is.na(`Training.compute..FLOP.`))
#Plot
plot(data$Publication.date,
log10(data$Training.compute..FLOP.),
ylim = c(16, 25),
pch = 20,
col = alpha('#3B9886', 0.5),
cex = 2,
ylab = 'Training compute (FLOPs)',
xlab = 'Release date',
cex.axis = 1.5,
cex.lab = 1.5,
bty = 'n',
las = 2)
data = read.csv('~/Documents/Conferences:trips/evolution_2025/talk/data/epochai_biology_ai_models.csv')
data = read.csv('~/Desktop/data.csv')
data
plot(data$Distance_to_tree_root, data$X8M)
?arcadia_palette
cols = arcadiathemeR::arcadia_palette('primary')
cols
plot(data$Distance_to_tree_root,
data$X8M,
type = 'l',
col = cols[1])
lines(data$Distance_to_tree_root,
data$X35M, col = cols[2])
plot(data$Distance_to_tree_root,
data$X8M,
type = 'l',
col = cols[1],
ylim = c(0, 2))
lines(data$Distance_to_tree_root,
data$X35M, col = cols[2])
plot(data$Distance_to_tree_root,
data$X8M,
type = 'l',
col = cols[1],
ylim = c(0, 1.5))
lines(data$Distance_to_tree_root,
data$X35M, col = cols[2])
lines(data$Distance_to_tree_root,
data$X150M, col = cols[3])
lines(data$Distance_to_tree_root,
data$X650M, col = cols[4])
lines(data$Distance_to_tree_root,
data$X3B, col = cols[5])
plot(data$Distance_to_tree_root,
data$X8M,
type = 'l',
col = cols[1],
ylim = c(0.5, 1.5))
lines(data$Distance_to_tree_root,
data$X35M, col = cols[2])
lines(data$Distance_to_tree_root,
data$X150M, col = cols[3])
lines(data$Distance_to_tree_root,
data$X650M, col = cols[4])
lines(data$Distance_to_tree_root,
data$X3B, col = cols[5])
plot(data$Distance_to_tree_root,
data$X8M,
type = 'l',
col = cols[1],
ylim = c(0.5, 1.5),
ylab = "Normalized pseudo-perplexity",
xlab = 'Evolutionary distance from WT'
cex.lab = 1.5,
plot(data$Distance_to_tree_root,
data$X8M,
type = 'l',
col = cols[1],
ylim = c(0.5, 1.5),
lwd = 1.5,
ylab = "Normalized pseudo-perplexity",
xlab = 'Evolutionary distance from WT',
cex.lab = 1.5,
cex.axis = 1.5)
lines(data$Distance_to_tree_root,
data$X35M, col = cols[2])
lines(data$Distance_to_tree_root,
data$X150M, col = cols[3])
lines(data$Distance_to_tree_root,
data$X650M, col = cols[4])
lines(data$Distance_to_tree_root,
data$X3B, col = cols[5])
cols[1]
cols[2]
cols[3]
cols[4]
cols[5]
setwd("~/Desktop/2025-bayesian-database-growth/code/")
# AFDB clusters
dat = readRDS("../data/afdb_clusters.RDS")
# AFDB NCBI taxonomy ids (for querying full taxonomy via taxonomizr)
afdb_taxonomy = readRDS("../data/afdb_cluster_taxonomy.RDS")
# Genome size statistics
genome_stats = readRDS('../data/afdb_genome_size_stats.RDS')
# Timetree phylogeny
tree = readRDS('../data/timetree_phylogeny_cleaned.RDS')
# Prepare database
prepareDatabase(getAccessions = FALSE)
source('utils.R')
# Prepare database
prepareDatabase(getAccessions = FALSE)
# Collect taxonomy
taxonomy <- getRawTaxonomy(unique(afdb_taxonomy$ncbi_id))
# Change names
names(taxonomy) <- as.character(unique(afdb_taxonomy$ncbi_id))
# Simplify taxonomy
taxonomy <- simplify_ncbi(taxonomy)
# Add protein n to 'genome_stats'
dat_species = split(dat, dat$taxonomy_ID)
species_protein_n = unlist(lapply(dat_species, function(x) nrow(x)))
genome_stats$protein_n = species_protein_n[match(genome_stats$ncbi_id,
names(species_protein_n))]
# Add kingdom and phylum to genome_stats
genome_stats$superkingdom = afdb_taxonomy$superkingdom[match(genome_stats$ncbi_id,
afdb_taxonomy$ncbi_id)]
genome_stats$phylum = afdb_taxonomy$phylum[match(genome_stats$ncbi_id,
afdb_taxonomy$ncbi_id)]
#Split and filter
genome_stats_split = split(genome_stats, genome_stats$superkingdom)
genome_stats_split$Archaea = genome_stats_split$Archaea[genome_stats_split$Archaea$protein_n>=500,]
genome_stats_split$Bacteria = genome_stats_split$Bacteria[genome_stats_split$Bacteria$protein_n>=500,]
genome_stats_split$Eukaryota = genome_stats_split$Eukaryota[genome_stats_split$Eukaryota$protein_n>=5000,]
# Recombine
genome_stats_filter = do.call(rbind, genome_stats_split)
# Filter data
dat_filter = dat[dat$taxonomy_ID %in% genome_stats_filter$ncbi_id,]
# Split dat on phyla
dat_phyla = split(dat_filter,
afdb_taxonomy$phylum[match(dat_filter$taxonomy_ID,
afdb_taxonomy$ncbi_id)])
# Count species n per phylum
species_n = unlist(lapply(dat_phyla, function(x) length(unique(x$taxonomy_ID))))
# Filter
dat_phyla = dat_phyla[species_n>=10]
# ID all clusters
clusters = unique(dat$cluster_ID)
# Make small dat
dat_small = dat_filter[sample(1:nrow(dat_filter), 1000000),]
# Get taxonomic ids
ids <- name2taxid(tree$tip.label,
out_type = "summary"
)
#Get taxonomy
tree_taxonomy = getRawTaxonomy(unique(ids$id))
# Change names
names(tree_taxonomy) <- as.character(unique(ids$id))
# Simplify taxonomy
tree_taxonomy <- simplify_ncbi(tree_taxonomy)
#Get phylum tree
phylum_tree <- simplify_tree(tree,
tree_taxonomy,
"phylum")
#Set up plotting colors
kingdom = taxonomy$kingdom[match(names(dat_phyla),
taxonomy$phylum)]
names(kingdom) = names(dat_phyla)
kingdom[grep('Oomycota', names(kingdom))] = 'Chromista'
kingdom[grep('Euryarchaeota', names(kingdom))] = 'Methanobacteriati'
kingdom[is.na(kingdom)] = 'Unplaced'
n = length(unique(kingdom))
phylum_cols = arcadia_palette('primary')
names(phylum_cols) = unique(kingdom)
phylum_cols = phylum_cols[match(kingdom, names(phylum_cols))]
phylum_cols[grep('Unplaced', names(phylum_cols))] = 'grey90'
names(phylum_cols) = names(dat_phyla)
kingdom_cols = arcadia_palette('primary')
names(kingdom_cols) = unique(kingdom)
kingdom_cols = kingdom_cols[match(kingdom, names(kingdom_cols))]
kingdom_cols[grep('Unplaced', names(kingdom_cols))] = 'grey90'
kingdom_cols = kingdom_cols[unique(names(kingdom_cols))]
saveRDS(kingdom_cols, '../data/kingdom_colors.RDS')
saveRDS(phylum_cols, '../data/phylum_colors.RDS')
saveRDS(tree_taxonomy, '../data/tree_taxonomy.RDS')
saveRDS(phylum_tree, '../data/phylum_tree.RDS')
saveRDS(dat_small, '../data/afdb_filtered_1M_proteins.RDS')
saveRDS(dat_filter, '../data/afdb_filtered_complete_proteomes.RDS')
saveRDS(dat_phyla, '../data/afdb_filtered_complete_proteomes_10species_per_phylum.RDS')
saveRDS(genome_stats_filter, '../data/afdb/genome_stats_of_afdb_filtered.RDS')
saveRDS(genome_stats_filter, '../data/afdb_genome_stats_of_afdb_filtered.RDS')
list.files()
system('rm nameNode.sqlite names.dmp nodes.dmp')
styler:::style_active_file()
saveRDS(taxonomy, "../data/afdb_filtered_taxonomy.RDS")
taxonomy = readRDS("../data/afdb_filtered_taxonomy.RDS")
